<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights Notebook Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/ipynb2web@latest/dist/ipynb2web.browser.mjs"
    ></script>
    <link rel="stylesheet" href="./index.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="module">
      // Notebook path mapping
      const notebookPaths = {
        '/': './ipynb/index.ipynb',
        '/index.html': './ipynb/index.ipynb', 
        '/audio.html': './ipynb/audio.ipynb',
        '/board_designs.html': './ipynb/board_design.ipynb',
        '/esp_idf.html': './ipynb/esp_idf.ipynb',
        '/esp_now.html': './ipynb/esp_now.ipynb',
        '/licensing.html': './ipynb/licensing.ipynb',
        '/lights.html': './ipynb/lights.ipynb',
        '/plan.html': './ipynb/plan.ipynb',
        '/upload.html': './ipynb/upload.ipynb', 
        '/web.html': './ipynb/web.ipynb',
        '/wled.html': './ipynb/wled.ipynb',
      };

      // Function to execute scripts in content
      function executeScripts(element) {
        // Get all script elements
        const scripts = element.querySelectorAll('script');
        scripts.forEach(oldScript => {
          // Create a new script element
          const newScript = document.createElement('script');
          
          // Copy all attributes from the old script to the new one
          Array.from(oldScript.attributes).forEach(attr => {
            newScript.setAttribute(attr.name, attr.value);
          });
          
          // Set the content of the new script
          newScript.textContent = oldScript.textContent;
          
          // Replace the old script with the new one
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // Function to load notebook content
      async function loadNotebook(notebookPath) {
        const contentDiv = document.getElementById("content");
        contentDiv.innerHTML = '<div class="loading">Loading notebook...</div>';
        
        try {
          const meta = await ipynb2web.nb2json(notebookPath);
          console.log("Loaded notebook:", notebookPath, meta);
          
          // Create the header with metadata
          let headerHTML = '';
          if (meta && meta.meta) {
            // Extract page title - use filename if title is not available
            const pageTitle = meta.meta.title || meta.meta.filename.replace('.ipynb', '') || 'Notebook';
            
            // Get current path from URL or stored data attribute
            const currentPath = document.body.dataset.currentNotebook || '/';
            const pageName = currentPath.split('/').pop().replace('.html', '');
            
            // Format the header title
            const headerTitle = pageName === '' || pageName === 'index' 
              ? pageTitle 
              : `${pageTitle}`;
            
            // Get description
            const description = meta.meta.summary || '';
            
            // Create breadcrumb navigation
            const breadcrumb = pageName === '' || pageName === 'index'
              ? '<div class="breadcrumb">Home</div>'
              : `<div class="breadcrumb"><a href="/">Home</a> &raquo; ${pageName.charAt(0).toUpperCase() + pageName.slice(1)}</div>`;
            
            headerHTML = `
              <div class="page-header">
                ${breadcrumb}
                <h1>${headerTitle}</h1>
                ${description ? `<p class="description">${description}</p>` : ''}
              </div>
            `;
          }
          
          // Insert the header and content
          contentDiv.innerHTML = headerHTML + meta.content;
          
          // Execute any scripts in the content
          executeScripts(contentDiv);
        } catch (error) {
          console.error("Error loading notebook:", error);
          contentDiv.innerHTML = `<div class="error">Error loading notebook: ${notebookPath}<br>${error.message}</div>`;
        }
      }

      // Function to navigate to a path and update URL
      function navigateToPath(path) {
        if (notebookPaths[path]) {
          document.body.dataset.currentNotebook = path;
          // Update URL with hash - keep the leading / in hash
          const hashPath = path === '/' ? '' : path.replace('.html', '');
          window.history.pushState({ path: path }, '', hashPath ? `#${hashPath}` : '#');
          loadNotebook(notebookPaths[path]);
          // Scroll to top when navigating
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }

      // Function to intercept all link clicks
      function interceptLinks() {
        // Add click event to document to catch all anchor clicks
        document.addEventListener('click', function(e) {
          // Check if clicked element is an anchor tag or inside one
          const link = e.target.closest('a');
          if (!link) return;
          
          const href = link.getAttribute('href');
          
          // Only intercept links that start with "/" (internal links)
          if (href && href.startsWith('/')) {
            e.preventDefault();
            
            let path = href;
            
            // Handle paths without .html extension
            if (!path.includes('.') && path !== '/') {
              path = `${path}.html`;
            }
            
            // Navigate to the path
            navigateToPath(path);
          }
          // External links and other links will work normally
        });
      }

      // Handle popstate events (browser back/forward) and hash changes
      window.addEventListener('popstate', function(e) {
        const path = e.state?.path || getPathFromHash();
        const notebookPath = notebookPaths[path] || notebookPaths['/'];
        document.body.dataset.currentNotebook = path;
        loadNotebook(notebookPath);
        // Scroll to top when using browser navigation
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Function to get path from current hash
      function getPathFromHash() {
        const hash = window.location.hash.substring(1); // Remove #
        if (!hash) return '/';
        
        // Handle hash paths that start with / (like #/audio)
        if (hash.startsWith('/')) {
          return hash.includes('.') ? hash : `${hash}.html`;
        }
        
        // Handle hash paths without leading / (like #audio)
        return hash.includes('.') ? `/${hash}` : `/${hash}.html`;
      }

      // Initial load based on current hash
      function loadInitialContent() {
        const path = getPathFromHash();
        const notebookPath = notebookPaths[path] || notebookPaths['/'];
        document.body.dataset.currentNotebook = path;
        // Set initial state
        window.history.replaceState({ path: path }, '', window.location.hash || '#');
        loadNotebook(notebookPath);
      }

      // Start the app
      interceptLinks();
      loadInitialContent();
    </script>
  </body>
</html>