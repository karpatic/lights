<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LED Lights Controller</title>
  <script> window.w=window</script>
  <style> 
  </style>
  <link rel="stylesheet" href="./bt.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>LED Controller</h1>
      <p>Control your smart LED strips with precision and style</p>
    </div>

    <div class="connect-card" id="connectCard">
      <h2>Connect to Your LED Strip</h2>
      <p>Establish a Bluetooth connection to start controlling your lights</p>
      <button class="connect-btn" id="btConnect" onclick="window.ble()">
        Connect via Bluetooth
        <span class="status-indicator" id="statusIndicator"></span>
      </button>
    </div>

    <div id="btDash" class="dashboard hidden">
      <div class="card">
        <h3>Colors</h3>
        <div class="colors-grid">
          <div class="control-group">
            <label for="colorOne">Primary Color</label>
            <input type="color" class="color-input" id="colorOne" value="#ff00cb" />
          </div>
          <div class="control-group">
            <label for="colorTwo">Secondary Color</label>
            <input type="color" class="color-input" id="colorTwo" value="#ff0000" />
          </div>
          <div class="control-group">
            <label for="colorThree">Accent Color</label>
            <input type="color" class="color-input" id="colorThree" value="#0000ff" />
          </div>
        </div>
        <div style="margin-top: 12px;">
          <button class="anim-btn random-btn" onclick="w.randomizeColors()">ðŸŽ² Random Colors</button>
        </div>
      </div>

      <div class="card">
        <h3>Mode Settings</h3>
        <div class="settings-grid">
          <div class="control-group">
            <label for="brightness">Brightness</label>
            <input type="number" class="number-input" step="5" min="0" max="100" id="brightness" value="20"/>
          </div>
          <div class="control-group">
            <label for="speed">Speed</label>
            <input type="number" class="number-input" min="0" max="100" step="5" id="speed" value="50"/>
          </div>
          <div class="control-group">
            <label for="intensity">Intensity</label>
            <input type="number" class="number-input" min="0" max="100" step="5" id="intensity" value="75"/>
          </div>
          <div class="control-group">
            <label for="count">Count</label>
            <input type="number" class="number-input" min="1" max="10" step="1" id="count" value="2"/>
          </div>
          <div class="control-group">
            <label for="direction">Direction</label>
            <select class="number-input" id="direction">
              <option value="0" selected>Left to Right</option>
              <option value="1">Right to Left</option>
              <option value="2">Out to In</option>
              <option value="3">In to Out</option>
              <option value="4">In and Out</option>
            </select>
          </div>
        </div>
        <div class="control-group" style="margin-top: 12px;">
          <label for="animationMode">Animation Mode</label>
          <select class="number-input" id="animationMode">
            <!-- Base Layer Modes -->
            <option value="static" selected>Solid Color</option>
            <option value="statictri">Static Tri-Color</option>
            <option value="perlinmove">Perlin Move</option>
            <option value="stream">Stream</option>
            <option value="palette">Palette</option>
            <option value="plasma">Plasma</option>
            <option value="pacifica">Pacifica</option>
            <option value="sunrise">Sunrise</option>
            <option value="aurora">Aurora</option>
            
            <!-- Modifier Layer Modes -->
            <option value="percent">Percentage Display</option>
            <option value="percenttri">Percentage Tri-Color</option>
            <option value="shift">Color Shift</option>
            <option value="washingmachine">Washing Machine</option>
            <option value="blink">Blink</option>
            <option value="blinktoggle">Blink Toggle</option>
            <option value="blinkrandom">Blink Random</option>
            <option value="heartbeat">Heartbeat</option>
            <option value="twinkles">Twinkles</option>
            
            <!-- Overlay Modes -->
            <option value="swipe">Color Swipe</option>
            <option value="swiperandom">Random Swipe</option>
            <option value="colorloop">Color Loop</option>
            <option value="breath">Breath</option>
            <option value="sweep">Color Sweep</option>
            <option value="sweepdual">Dual Color Sweep</option>
            <option value="theater">Theater</option>
            <option value="fireworks">Fireworks</option>
            <option value="juggle">Juggle</option>
            <option value="bouncingballs">Bouncing Balls</option>
            <option value="meteor">Meteor</option>
            <option value="tetrix">Tetrix</option>
            <option value="candle">Candle</option>
          </select>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px;">
          <button class="anim-btn" style="flex: 1;" onclick="w.toggleAnimationMode(-1)">â–² Previous</button>
          <button class="anim-btn" style="flex: 1;" onclick="w.toggleAnimationMode(1)">â–¼ Next</button>
        </div>
      </div>

      <div class="card">
        <h3>Hardware Configuration</h3>
        <div class="settings-grid">
          <div class="control-group">
            <label for="ledCount">LED Count</label>
            <input type="number" class="number-input" min="5" max="400" step="5" id="ledCount" value="300"/>
          </div>
          <div class="control-group">
            <label for="pixelPin">Pixel Pin</label>
            <input type="number" class="number-input" min="0" max="33" id="pixelPin" value="15"/>
          </div>
          <div class="control-group">
            <label for="colorOrder">Color Order</label>
            <select class="number-input" id="colorOrder">
              <option value="NEO_RGB">RGB</option>
              <option value="NEO_GRB" selected>GRB (Most Common)</option>
              <option value="NEO_BRG">BRG</option>
              <option value="NEO_BGR">BGR</option>
              <option value="NEO_RBG">RBG</option>
              <option value="NEO_GBR">GBR</option>
            </select>
          </div>
          <div class="control-group">
            <label for="maxCurrent">Max Current (mA)</label>
            <input type="number" class="number-input" min="500" max="20000" step="100" id="maxCurrent" value="8000"/>
          </div>
        </div>
      </div>
    </div>

    <div id="lights"></div>
  </div>

  <script type="module">
    console.log('Starting'); 
    
    // Default values object
    const DEFAULT_VALUES = {
      colorOne: 0xFF00CB,    // Hot pink as hex
      colorTwo: 0xFF0000,    // Red as hex
      colorThree: 0x0000FF,  // Blue as hex
      brightness: 20,        // Match main.cpp default
      speed: 50,
      count: 2,              // Match main.cpp default  
      intensity: 75,
      direction: 0,
      ledCount: 300,         // Match main.cpp default
      pixelPin: 15,
      maxCurrent: 8000,
      colorOrder: 'NEO_GRB', // Match main.cpp default
      lightMode: 'static',
      updated: true
    };

    // Initialize localStorage and load default values
    function initializeDefaultValues() {
      let storedValues = localStorage.getItem('ledControllerDefaults');
      
      if (!storedValues) {
        console.log('No stored defaults found, creating initial values');
        localStorage.setItem('ledControllerDefaults', JSON.stringify(DEFAULT_VALUES));
        return DEFAULT_VALUES;
      } else {
        console.log('Loading stored defaults');
        try {
          const parsed = JSON.parse(storedValues);
          // Merge with defaults to ensure all properties exist and ensure updated is true
          return { ...DEFAULT_VALUES, ...parsed, updated: true };
        } catch (error) {
          console.error('Error parsing stored defaults, using default values:', error);
          localStorage.setItem('ledControllerDefaults', JSON.stringify(DEFAULT_VALUES));
          return DEFAULT_VALUES;
        }
      }
    }

    // Save current values to localStorage
    function saveToLocalStorage() {
      if (window.myData) {
        const valuesToSave = {
          colorOne: window.myData.colorOne || DEFAULT_VALUES.colorOne,
          colorTwo: window.myData.colorTwo || DEFAULT_VALUES.colorTwo,
          colorThree: window.myData.colorThree || DEFAULT_VALUES.colorThree,
          brightness: window.myData.brightness || DEFAULT_VALUES.brightness,
          speed: window.myData.speed || DEFAULT_VALUES.speed,
          intensity: window.myData.intensity || DEFAULT_VALUES.intensity,
          count: window.myData.count || DEFAULT_VALUES.count,
          direction: window.myData.direction || DEFAULT_VALUES.direction,
          ledCount: window.myData.ledCount || DEFAULT_VALUES.ledCount,
          pixelPin: window.myData.pixelPin || DEFAULT_VALUES.pixelPin,
          maxCurrent: window.myData.maxCurrent || DEFAULT_VALUES.maxCurrent,
          colorOrder: window.myData.colorOrder || DEFAULT_VALUES.colorOrder,
          lightMode: window.myData.lightMode || DEFAULT_VALUES.lightMode,
          updated: true
        };
        
        localStorage.setItem('ledControllerDefaults', JSON.stringify(valuesToSave));
        console.log('Values saved to localStorage:', valuesToSave);
      }
    }

    // Convert hex integer to hex color string for input
    function hexIntToColor(hexInt) {
      return '#' + hexInt.toString(16).padStart(6, '0');
    }

    // Convert hex color string to hex integer
    function colorToHexInt(colorString) {
      return parseInt(colorString.slice(1), 16);
    }

    // Load values into UI elements
    function loadValuesToUI(values) {
      console.log('Loading values to UI:', values);
      
      // Initialize window.myData with stored values if it doesn't exist
      if (!window.myData) {
        window.myData = {};
      }
      
      // Update window.myData with stored values and ensure updated is true
      Object.assign(window.myData, values, { updated: true });
      console.log('window.myData updated with stored values:', window.myData);
      
      // Load color values - convert hex integers to color strings
      const colorOne = document.getElementById('colorOne');
      const colorTwo = document.getElementById('colorTwo');
      const colorThree = document.getElementById('colorThree');
      
      if (colorOne && values.colorOne !== undefined) {
        colorOne.value = hexIntToColor(values.colorOne);
      }
      if (colorTwo && values.colorTwo !== undefined) {
        colorTwo.value = hexIntToColor(values.colorTwo);
      }
      if (colorThree && values.colorThree !== undefined) {
        colorThree.value = hexIntToColor(values.colorThree);
      }
      
      // Load number values
      const brightness = document.getElementById('brightness');
      const speed = document.getElementById('speed');
      const intensity = document.getElementById('intensity');
      const count = document.getElementById('count');
      const direction = document.getElementById('direction');
      const ledCount = document.getElementById('ledCount');
      const pixelPin = document.getElementById('pixelPin');
      const maxCurrent = document.getElementById('maxCurrent');
      const colorOrder = document.getElementById('colorOrder');
      
      if (brightness) brightness.value = values.brightness;
      if (speed) speed.value = values.speed;
      if (count) count.value = values.count;
      if (intensity) intensity.value = values.intensity;
      if (direction) direction.value = values.direction;
      if (ledCount) ledCount.value = values.ledCount;
      if (pixelPin) pixelPin.value = values.pixelPin;
      if (maxCurrent) maxCurrent.value = values.maxCurrent;
      if (colorOrder) colorOrder.value = values.colorOrder;
      
      console.log('UI elements updated with stored values');
    }

    async function loadScript() {  
      let isDev = window.location.origin.includes('localhost'); 
      let scriptPath = '/lights.js';
      try { 
        const module = await import(scriptPath);
        console.log('lights.js loaded successfully');
        
        // Initialize myData with stored values after lights.js loads
        setTimeout(() => {
          const storedValues = initializeDefaultValues();
          if (!window.myData) {
            window.myData = {};
          }
          Object.assign(window.myData, storedValues, { updated: true });
          console.log('window.myData initialized after lights.js load:', window.myData);
        }, 100);
        
      } catch (error) { 
        console.error('Failed to load script from', scriptPath); 
      }
      window.lights = document.getElementById('lights');
      console.log('window', window); 
    } 
    loadScript();

    // Debug: Check if color inputs are working
    window.addEventListener('load', function() {
      setTimeout(() => {
        const colorInputs = document.querySelectorAll('input[type="color"]');
        console.log('Found color inputs:', colorInputs.length);
        colorInputs.forEach(input => {
          console.log('Color input:', input.id, 'value:', input.value);
          // Add manual test listener with BLE write functionality
          input.addEventListener('input', function() {
            console.log('Manual listener - Color input changed:', this.id, this.value);
            
            // Convert color string to hex integer
            const hexInt = colorToHexInt(this.value);
            
            // Map UI element IDs to data keys
            const colorMap = {
              'colorOne': 'colorOne',
              'colorTwo': 'colorTwo', 
              'colorThree': 'colorThree'
            };
            
            const dataKey = colorMap[this.id];
            if (dataKey && window.myData) {
              window.myData[dataKey] = hexInt;
              window.myData.updated = true;
              console.log('Color updated:', dataKey, '=', hexInt, '(0x' + hexInt.toString(16) + ')');
              
              // Save to localStorage
              saveToLocalStorage();
              
              if (window.saveSettings) window.saveSettings();
              
              // Write to BLE if connected
              if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
                console.log('Writing color change to BLE...');
                if (window.bleWrite) window.bleWrite();
              } else {
                console.log('BLE not connected, color saved locally only');
              }
            }
          });
        });
      }, 500);
    });

    // Add connection status management
    window.updateConnectionStatus = function(connected) {
      const indicator = document.getElementById('statusIndicator');
      const connectCard = document.getElementById('connectCard');
      const dashboard = document.getElementById('btDash');
      
      console.log('updateConnectionStatus called with:', connected);
      
      if (connected) {
        if (indicator) indicator.classList.add('connected');
        if (connectCard) connectCard.classList.add('hidden');
        if (dashboard) {
          dashboard.classList.remove('hidden');
          console.log('Dashboard now visible');
        }
      } else {
        if (indicator) indicator.classList.remove('connected');
        if (connectCard) connectCard.classList.remove('hidden');
        if (dashboard) dashboard.classList.add('hidden');
      }
    };

    // Monitor for connection status changes
    window.checkConnectionStatus = function() {
      const isConnected = window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected;
      const dashboard = document.getElementById('btDash');
      const connectCard = document.getElementById('connectCard');
      const statusIndicator = document.getElementById('statusIndicator');
      
      // Add debug output
      if (window.lastConnectionState !== isConnected) {
        console.log('Connection state changed:', window.lastConnectionState, '->', isConnected);
        window.lastConnectionState = isConnected;
      }
      
      if (isConnected && dashboard && dashboard.classList.contains('hidden')) {
        console.log('Connection detected, showing dashboard');
        dashboard.classList.remove('hidden');
        dashboard.style.display = 'grid';
        if (connectCard) connectCard.classList.add('hidden');
        if (statusIndicator) statusIndicator.classList.add('connected');
      } else if (!isConnected && dashboard && !dashboard.classList.contains('hidden')) {
        console.log('Connection lost, hiding dashboard');
        dashboard.classList.add('hidden');
        if (connectCard) connectCard.classList.remove('hidden');
        if (statusIndicator) statusIndicator.classList.remove('connected');
      }
    };

    // Test BLE write function
    window.testBLEWrite = function() {
      if (window.bleWrite && window.myData) {
        console.log('Testing BLE write with current data:', window.myData);
        window.bleWrite();
      } else {
        console.error('BLE write function or myData not available');
      }
    };

    // Add number input listeners for immediate updates
    window.addEventListener('load', function() {
      // Initialize default values first
      const storedValues = initializeDefaultValues();
      
      // Initialize window.myData early if it doesn't exist
      if (!window.myData) {
        window.myData = {};
      }
      Object.assign(window.myData, storedValues, { updated: true });
      console.log('window.myData initialized on load:', window.myData);
      
      // Wait for elements to be available, then load stored values
      setTimeout(() => {
        loadValuesToUI(storedValues);
        
        // Add listeners for number inputs
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
          input.addEventListener('change', function() {
            console.log('Number input changed:', this.id, this.value);
            
            const inputMap = {
              'brightness': 'brightness',
              'speed': 'speed',
              'intensity': 'intensity',
              'count': 'count',
              'ledCount': 'ledCount',
              'pixelPin': 'pixelPin',
              'maxCurrent': 'maxCurrent'
            };
            
            const dataKey = inputMap[this.id];
            if (dataKey && window.myData) {
              window.myData[dataKey] = parseInt(this.value);
              window.myData.updated = true;
              console.log('Updated:', dataKey, '=', window.myData[dataKey]);
              
              // Save to localStorage
              saveToLocalStorage();
              
              if (window.saveSettings) window.saveSettings();
              
              // Write to BLE if connected
              if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
                console.log('Writing number change to BLE...');
                if (window.bleWrite) {
                  window.bleWrite();
                } else {
                  console.error('bleWrite function not available');
                }
              }
            }
          });
        });
        
        // Add listener for select dropdowns (color order and direction)
        const selectInputs = document.querySelectorAll('select');
        selectInputs.forEach(select => {
          select.addEventListener('change', function() {
            console.log('Select input changed:', this.id, this.value);
            
            const selectMap = {
              'colorOrder': 'colorOrder',
              'direction': 'direction'
            };
            
            const dataKey = selectMap[this.id];
            if (dataKey && window.myData) {
              if (dataKey === 'direction') {
                window.myData[dataKey] = parseInt(this.value);
              } else {
                window.myData[dataKey] = this.value;
              }
              window.myData.updated = true;
              console.log('Updated:', dataKey, '=', window.myData[dataKey]);
              
              // Save to localStorage
              saveToLocalStorage();
              
              if (window.saveSettings) window.saveSettings();
              
              // Write to BLE if connected
              if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
                console.log('Writing select change to BLE...');
                if (window.bleWrite) {
                  window.bleWrite();
                } else {
                  console.error('bleWrite function not available');
                }
              }
            }
          });
        });

        // Debug: Check if color inputs are working
        const colorInputs = document.querySelectorAll('input[type="color"]');
        console.log('Found color inputs:', colorInputs.length);
        colorInputs.forEach(input => {
          console.log('Color input:', input.id, 'value:', input.value);
          // Add manual test listener with BLE write functionality
          input.addEventListener('input', function() {
            console.log('Manual listener - Color input changed:', this.id, this.value);
            
            // Convert color string to hex integer
            const hexInt = colorToHexInt(this.value);
            
            // Map UI element IDs to data keys
            const colorMap = {
              'colorOne': 'colorOne',
              'colorTwo': 'colorTwo', 
              'colorThree': 'colorThree'
            };
            
            const dataKey = colorMap[this.id];
            if (dataKey && window.myData) {
              window.myData[dataKey] = hexInt;
              window.myData.updated = true;
              console.log('Color updated:', dataKey, '=', hexInt, '(0x' + hexInt.toString(16) + ')');
              
              // Save to localStorage
              saveToLocalStorage();
              
              // Save settings
              if (window.saveSettings) window.saveSettings();
              
              // Write to BLE if connected
              if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
                console.log('Writing color change to BLE...');
                if (window.bleWrite) window.bleWrite();
              } else {
                console.log('BLE not connected, color saved locally only');
              }
            }
          });
        });
      }, 500);

      setTimeout(() => {  
        // Add listener for animation mode select
        const animationMode = document.getElementById('animationMode');
        if (animationMode) {
          animationMode.addEventListener('change', function() {
            console.log('Animation mode changed:', this.value);
            
            if (window.myData) {
              window.myData.lightMode = this.value;
              window.myData.updated = true;
              console.log('Updated lightMode:', window.myData.lightMode);
              
              // Save to localStorage
              saveToLocalStorage();
              
              if (window.saveSettings) window.saveSettings();
              
              // Write to BLE if connected
              if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
                console.log('Writing animation mode change to BLE...');
                if (window.bleWrite) window.bleWrite();
              }
            }
          });
          
          // Load stored animation mode
          if (window.myData && window.myData.lightMode) {
            animationMode.value = window.myData.lightMode;
          }
        } 
      }, 500);

    });  

    // Add animation mode handling
    window.toggleAnimationMode = function(direction) {
      const animationSelect = document.getElementById('animationMode');
      if (!animationSelect) return;
      
      const options = animationSelect.options;
      let currentIndex = animationSelect.selectedIndex;
      
      currentIndex += direction;
      
      // Wrap around
      if (currentIndex < 0) {
        currentIndex = options.length - 1;
      } else if (currentIndex >= options.length) {
        currentIndex = 0;
      }
      
      animationSelect.selectedIndex = currentIndex;
      
      // Update myData and trigger BLE write
      if (window.myData) {
        window.myData.lightMode = animationSelect.value;
        window.myData.updated = true;
        console.log('Animation mode changed to:', window.myData.lightMode);
        
        // Save to localStorage
        saveToLocalStorage();
        
        if (window.saveSettings) window.saveSettings();
        
        // Write to BLE if connected
        if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
          console.log('Writing animation mode change to BLE...');
          if (window.bleWrite) window.bleWrite();
        }
      }
    };

    // Add random colors function
    window.randomizeColors = function() {
      const colorInputs = [
        document.getElementById('colorOne'),
        document.getElementById('colorTwo'),
        document.getElementById('colorThree')
      ];
      
      const colorKeys = ['colorOne', 'colorTwo', 'colorThree'];
      
      colorInputs.forEach((input, index) => {
        if (input) {
          // Generate random color
          const randomHexInt = Math.floor(Math.random() * 0xFFFFFF);
          const randomColor = hexIntToColor(randomHexInt);
          input.value = randomColor;
          
          // Update myData
          if (window.myData) {
            window.myData[colorKeys[index]] = randomHexInt;
            window.myData.updated = true;
            console.log('Random color generated:', colorKeys[index], '=', randomHexInt, '(0x' + randomHexInt.toString(16) + ')');
          }
        }
      });
      
      // Save to localStorage
      saveToLocalStorage();
      
      if (window.saveSettings) window.saveSettings();
      
      // Write to BLE if connected
      if (window.charac && window.charac.service && window.charac.service.device && window.charac.service.device.gatt.connected) {
        console.log('Writing random colors to BLE...');
        if (window.bleWrite) window.bleWrite();
      }
    }; 
  </script>
</body>
</html>